<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Webcam con Detecci√≥n de Rostro</title>
    
    <style>
        /* === Estilos Generales === */
        body {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            margin: 0;
            background-color: #f0f0f0;
            font-family: sans-serif;
        }

        /* === Contenedor de la C√°mara y el Overlay === */
        .camera-container {
            position: relative;
            width: 100%;
            max-width: 800px;
            overflow: hidden;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            aspect-ratio: 4 / 3; 
        }

        /* === Elemento de Video (C√°mara) === */
        #camera-preview {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
            transform: scaleX(-1); /* Volteo de espejo */
        }

        /* === Overlay SVG (El hueco) === */
        #overlay-svg {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none; 
        }

        /* === Canvas de Detecci√≥n === */
        #detection-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            transform: scaleX(-1); 
        }

    </style>
</head>
<body>

    <h1>Detecci√≥n de Rostro en Vivo</h1>
    <p id="loading-message" style="text-align: center;">Cargando modelos de IA... üß†</p>
    
    <div class="camera-container">
        
        <video id="camera-preview" autoplay playsinline muted></video>

        <svg id="overlay-svg" viewBox="0 0 100 100" preserveAspectRatio="none">
            <path fill-rule="evenodd" 
                  fill="rgba(255, 255, 255, 0.85)"
                  d="M 0 0 H 100 V 100 H 0 Z 
                     M 50 30 
                     A 15 20 0 1 1 50 70 
                     A 15 20 0 1 1 50 30 Z">
            </path>
            <path fill="none"
                  stroke="#007bff"
                  stroke-width="0.5"
                  stroke-dasharray="2 2"
                  d="M 50 30 
                     A 15 20 0 1 1 50 70 
                     A 15 20 0 1 1 50 30 Z">
            </path>
        </svg>

        <canvas id="detection-canvas"></canvas>

    </div>

    <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>

    <script>
        const videoElement = document.getElementById('camera-preview');
        const canvas = document.getElementById('detection-canvas');
        const loadingMessage = document.getElementById('loading-message');
        
        const MODEL_URL = 'https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/weights';

        // --- Cargar los Modelos (Modificado) ---
        async function loadModels() {
            try {
                // Ahora 'faceapi' deber√≠a estar definido
                await faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL);
                await faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL);
                console.log("Modelos de face-api.js cargados correctamente.");
                loadingMessage.innerText = "¬°Modelos cargados! Iniciando c√°mara...";
            } catch (error) {
                console.error("Error al cargar los modelos de face-api.js: ", error);
                loadingMessage.innerText = "‚ùå Error al cargar los modelos. Revisa la consola.";
                // ** CAMBIO CLAVE 2: Lanzar el error para detener 'main' **
                throw new Error("Fallo al cargar modelos");
            }
        }

        // --- Iniciar la C√°mara ---
        async function startCamera() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: true });
                videoElement.srcObject = stream;
                // No llamamos a play() aqu√≠, esperamos al evento 'play'
            } catch (error) {
                console.error("Error al acceder a la c√°mara: ", error);
                loadingMessage.innerText = "‚ùå Error al acceder a la c√°mara. Aseg√∫rate de dar permisos.";
            }
        }

        // --- Loop de Detecci√≥n y Dibujo ---
        async function startFaceDetection() {
            console.log("Iniciando detecci√≥n de rostros...");
            loadingMessage.style.display = 'none'; // Ocultamos el mensaje de carga

            const displaySize = { width: videoElement.clientWidth, height: videoElement.clientHeight };
            faceapi.matchDimensions(canvas, displaySize);

            setInterval(async () => {
                try {
                    const detections = await faceapi.detectAllFaces(
                        videoElement, 
                        new faceapi.TinyFaceDetectorOptions()
                    ).withFaceLandmarks();

                    const resizedDetections = faceapi.resizeResults(detections, displaySize);

                    canvas.getContext('2d').clearRect(0, 0, canvas.width, canvas.height);

                    faceapi.draw.drawDetections(canvas, resizedDetections);
                    faceapi.draw.drawFaceLandmarks(canvas, resizedDetections);

                } catch (error) {
                    // Este catch es para errores *durante* la detecci√≥n, no en la carga
                    console.error("Error en el loop de detecci√≥n: ", error);
                }
            }, 100); 
        }

        // --- Funci√≥n Principal (Modificada) ---
        async function main() {
            // ** CAMBIO CLAVE 3: Envolvemos 'main' en try...catch **
            try {
                // 1. Cargamos los modelos
                await loadModels();
                
                // 2. Iniciamos la c√°mara (Solo si los modelos cargaron bien)
                await startCamera();

                videoElement.addEventListener('play', () => {
                    startFaceDetection();
                });

            } catch (error) {
                console.error("No se pudo iniciar la aplicaci√≥n:", error.message);
            }
        }

        // ¬°Ejecutamos la funci√≥n principal!
        main();

    </script>
</body>
</html>